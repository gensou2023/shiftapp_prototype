<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShiftOptimizer AI - シフト最適化デモ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ===== Design Tokens ===== */
:root {
  --color-primary: #1a73e8;
  --color-primary-container: #d2e3fc;
  --color-on-primary: #ffffff;
  --color-surface: #fafafa;
  --color-surface-container: #f0f0f0;
  --color-on-surface: #1a1a1a;
  --color-on-surface-variant: #6b6b6b;
  --color-success: #1a7f37;
  --color-success-muted: #dafbe1;
  --color-warning: #9a6700;
  --color-warning-muted: #fff8c5;
  --color-danger: #cf222e;
  --color-danger-muted: #ffebe9;
  --border-default: #d0d7de;
  --border-muted: #e8e8e8;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-6: 24px;
  --space-8: 32px;
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-full: 9999px;
  --transition: .3s cubic-bezier(.4,0,.2,1);
}

/* ===== Reset & Base ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Noto Sans JP', 'Inter', sans-serif;
  background: var(--color-surface);
  color: var(--color-on-surface);
  overflow: hidden;
  height: 100vh;
  font-size: 14px;
  line-height: 1.6;
}

/* ===== Navigation ===== */
.nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  background: #1a1a2e;
  display: flex; align-items: center;
  padding: 0 var(--space-6); height: 52px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.nav-brand {
  font-weight: 700; font-size: 16px; color: #fff;
  margin-right: var(--space-8); white-space: nowrap;
  display: flex; align-items: center; gap: var(--space-2);
}
.nav-brand svg { flex-shrink: 0; }
.nav-tabs-container {
  display: flex; gap: var(--space-1); overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.nav-tab {
  padding: 14px 16px; color: rgba(255,255,255,0.5);
  font-size: 13px; font-weight: 500; cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition); white-space: nowrap;
}
.nav-tab:hover { color: rgba(255,255,255,0.8); }
.nav-tab.active { color: #fff; border-bottom-color: var(--color-primary); }
.nav-spacer { flex: 1; }
.nav-user {
  display: flex; align-items: center; gap: var(--space-2);
  color: rgba(255,255,255,0.7); font-size: 13px; white-space: nowrap;
}
.nav-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--color-primary);
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 13px; font-weight: 600;
}

/* ===== Page Container ===== */
.page {
  display: none; height: calc(100vh - 52px); margin-top: 52px;
  overflow-y: auto; padding: var(--space-6);
}
.page.active { display: block; }
.page-title { font-size: 24px; font-weight: 700; margin-bottom: var(--space-1); }
.page-subtitle { font-size: 14px; color: var(--color-on-surface-variant); margin-bottom: var(--space-6); }
.page-inner { max-width: 1200px; margin: 0 auto; }

/* ===== Cards ===== */
.card {
  background: #fff; border: 1px solid var(--border-default);
  border-radius: var(--radius-md); box-shadow: var(--shadow-sm);
}
.card-header {
  padding: var(--space-4) var(--space-6);
  border-bottom: 1px solid var(--border-muted);
  font-weight: 600; font-size: 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.card-body { padding: var(--space-6); }

/* ===== Stat Cards ===== */
.stats-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: var(--space-4); margin-bottom: var(--space-6);
}
.stat-card {
  background: #fff; border: 1px solid var(--border-default);
  border-radius: var(--radius-md); padding: var(--space-6);
  box-shadow: var(--shadow-sm);
}
.stat-label {
  font-size: 12px; color: var(--color-on-surface-variant);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: var(--space-2);
}
.stat-value { font-size: 32px; font-weight: 700; }
.stat-sub { font-size: 12px; color: var(--color-success); margin-top: var(--space-1); }

/* ===== Badges ===== */
.badge {
  display: inline-flex; align-items: center;
  padding: 2px 10px; border-radius: var(--radius-full);
  font-size: 12px; font-weight: 500;
}
.badge-success { background: var(--color-success-muted); color: var(--color-success); }
.badge-warning { background: var(--color-warning-muted); color: var(--color-warning); }
.badge-danger { background: var(--color-danger-muted); color: var(--color-danger); }
.badge-muted { background: var(--color-surface-container); color: var(--color-on-surface-variant); }
.badge-primary { background: var(--color-primary-container); color: var(--color-primary); }

/* ===== Buttons ===== */
.btn {
  display: inline-flex; align-items: center; gap: var(--space-2);
  padding: 10px 20px; border-radius: var(--radius-md);
  font-size: 14px; font-weight: 600; cursor: pointer;
  font-family: inherit; transition: var(--transition); border: none;
}
.btn-primary {
  background: var(--color-primary); color: var(--color-on-primary);
  box-shadow: var(--shadow-sm);
}
.btn-primary:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
.btn-secondary {
  background: #fff; color: var(--color-on-surface);
  border: 1px solid var(--border-default);
}
.btn-secondary:hover { background: var(--color-surface-container); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn-lg { padding: 14px 28px; font-size: 16px; }

/* ===== Skill Stars ===== */
.skill-stars { display: inline-flex; gap: 2px; }
.skill-star { color: #e0e0e0; font-size: 14px; }
.skill-star.filled { color: #f4b400; }

/* ===== Quick Actions ===== */
.quick-actions { display: flex; gap: var(--space-3); margin-bottom: var(--space-6); flex-wrap: wrap; }

/* ===== Dashboard: Today Summary ===== */
.today-summary {
  background: #fff; border: 1px solid var(--border-default);
  border-radius: var(--radius-md); padding: var(--space-6);
  box-shadow: var(--shadow-sm); margin-bottom: var(--space-6);
}
.today-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-4); }
.today-title { font-size: 16px; font-weight: 600; }
.today-staff-list { display: flex; flex-wrap: wrap; gap: var(--space-2); }
.today-staff-chip {
  display: inline-flex; align-items: center; gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  background: var(--color-surface-container);
  border-radius: var(--radius-full); font-size: 13px;
}
.today-score { margin-top: var(--space-4); }
.score-bar-bg {
  height: 8px; background: var(--color-surface-container);
  border-radius: var(--radius-full); overflow: hidden;
}
.score-bar-fill {
  height: 100%; border-radius: var(--radius-full);
  transition: width 0.8s ease;
}
.score-info { display: flex; justify-content: space-between; margin-top: var(--space-1); font-size: 12px; color: var(--color-on-surface-variant); }

/* ===== Staff Grid ===== */
.staff-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: var(--space-4);
}
.staff-card {
  background: #fff; border: 1px solid var(--border-default);
  border-radius: var(--radius-md); padding: var(--space-6);
  box-shadow: var(--shadow-sm); transition: var(--transition);
  cursor: pointer;
}
.staff-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.staff-card-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3); }
.staff-avatar {
  width: 44px; height: 44px; border-radius: 50%;
  background: var(--color-primary-container); color: var(--color-primary);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 16px; flex-shrink: 0;
}
.staff-name { font-weight: 600; font-size: 15px; }
.staff-meta { font-size: 12px; color: var(--color-on-surface-variant); }
.staff-badges { display: flex; flex-wrap: wrap; gap: var(--space-1); margin-bottom: var(--space-2); }
.staff-note { font-size: 12px; color: var(--color-on-surface-variant); margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid var(--border-muted); }
.staff-rate { font-size: 13px; font-weight: 600; margin-top: var(--space-2); }

/* ===== Modal ===== */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 200;
  display: none; align-items: center; justify-content: center;
  padding: var(--space-4);
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff; border-radius: var(--radius-lg);
  width: 100%; max-width: 500px; max-height: 90vh;
  overflow-y: auto; box-shadow: var(--shadow-lg);
  animation: modalIn 0.3s ease;
}
@keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
.modal-header {
  padding: var(--space-6); border-bottom: 1px solid var(--border-muted);
  display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-size: 18px; font-weight: 700; }
.modal-close {
  width: 32px; height: 32px; border: none; background: var(--color-surface-container);
  border-radius: 50%; cursor: pointer; font-size: 18px;
  display: flex; align-items: center; justify-content: center;
}
.modal-body { padding: var(--space-6); }
.modal-footer {
  padding: var(--space-4) var(--space-6);
  border-top: 1px solid var(--border-muted);
  display: flex; justify-content: flex-end; gap: var(--space-2);
}
.form-group { margin-bottom: var(--space-4); }
.form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: var(--space-1); }
.form-input, .form-select {
  width: 100%; padding: var(--space-2) var(--space-3);
  border: 1px solid var(--border-default); border-radius: var(--radius-sm);
  font-size: 14px; font-family: inherit;
  transition: var(--transition);
}
.form-input:focus, .form-select:focus {
  outline: none; border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(26,115,232,0.15);
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); }
.checkbox-group { display: flex; flex-wrap: wrap; gap: var(--space-2); }
.checkbox-item {
  display: flex; align-items: center; gap: var(--space-1);
  padding: var(--space-1) var(--space-2);
  background: var(--color-surface-container);
  border-radius: var(--radius-sm); font-size: 13px; cursor: pointer;
}
.checkbox-item input { cursor: pointer; }

/* ===== Shift Generator ===== */
.shift-gen-layout { display: grid; grid-template-columns: 380px 1fr; gap: var(--space-6); }
.shift-input-panel .card { position: sticky; top: 0; }
.shift-date-input { width: 100%; }
.slot-toggles { display: flex; gap: var(--space-2); margin-top: var(--space-2); }
.slot-toggle {
  padding: var(--space-2) var(--space-4);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-full); font-size: 13px;
  cursor: pointer; transition: var(--transition);
  background: #fff; font-family: inherit;
}
.slot-toggle.active {
  background: var(--color-primary); color: #fff;
  border-color: var(--color-primary);
}
.level-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2); margin-top: var(--space-2); }
.level-btn {
  padding: var(--space-3) var(--space-4);
  border: 2px solid var(--border-default);
  border-radius: var(--radius-md); text-align: center;
  cursor: pointer; transition: var(--transition);
  background: #fff; font-family: inherit;
}
.level-btn:hover { border-color: var(--color-primary); }
.level-btn.active { border-color: var(--color-primary); background: var(--color-primary-container); }
.level-btn .level-name { font-weight: 600; font-size: 15px; display: block; }
.level-btn .level-score { font-size: 12px; color: var(--color-on-surface-variant); }
.shift-info-box {
  margin-top: var(--space-4); padding: var(--space-4);
  background: var(--color-surface-container); border-radius: var(--radius-md);
  font-size: 13px;
}
.shift-info-row { display: flex; justify-content: space-between; margin-bottom: var(--space-1); }
.shift-info-row:last-child { margin-bottom: 0; }
.btn-generate {
  width: 100%; margin-top: var(--space-4);
  padding: 14px; font-size: 16px; position: relative; overflow: hidden;
}
.btn-generate .pulse {
  position: absolute; top: 50%; left: 50%;
  width: 200%; height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.3), transparent 60%);
  transform: translate(-50%, -50%) scale(0);
  border-radius: 50%;
}
.btn-generate.animating .pulse {
  animation: pulseAnim 0.6s ease-out;
}
@keyframes pulseAnim { to { transform: translate(-50%, -50%) scale(1); opacity: 0; } }

/* ===== Shift Results ===== */
.shift-results { min-height: 200px; }
.result-placeholder {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 60px var(--space-6); text-align: center;
  color: var(--color-on-surface-variant);
}
.result-placeholder-icon { font-size: 48px; margin-bottom: var(--space-4); opacity: 0.5; }
.result-card {
  background: #fff; border: 1px solid var(--border-default);
  border-radius: var(--radius-md); box-shadow: var(--shadow-sm);
  margin-bottom: var(--space-4); overflow: hidden;
}
.result-card.primary { border-color: var(--color-primary); border-width: 2px; }
.result-card-header {
  padding: var(--space-4) var(--space-6);
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border-muted);
}
.result-card-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: var(--space-2); }
.result-card-body { padding: var(--space-6); }
.result-score-section { margin-bottom: var(--space-4); }
.score-gauge-bg {
  height: 12px; background: var(--color-surface-container);
  border-radius: var(--radius-full); overflow: hidden; position: relative;
}
.score-gauge-fill {
  height: 100%; border-radius: var(--radius-full);
  width: 0; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.score-gauge-target {
  position: absolute; top: -4px; bottom: -4px; width: 2px;
  background: var(--color-on-surface); opacity: 0.3;
}
.result-staff-grid {
  display: flex; flex-wrap: wrap; gap: var(--space-2);
  margin-bottom: var(--space-4);
}
.result-staff-chip {
  display: inline-flex; align-items: center; gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  background: var(--color-surface-container);
  border-radius: var(--radius-md); font-size: 13px;
  opacity: 0; transform: translateY(10px);
  transition: all 0.3s ease;
}
.result-staff-chip.visible { opacity: 1; transform: translateY(0); }
.result-staff-chip .chip-avatar {
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--color-primary-container); color: var(--color-primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 600;
}
.result-cost {
  font-size: 13px; color: var(--color-on-surface-variant);
  padding-top: var(--space-3); border-top: 1px solid var(--border-muted);
}
.result-cost strong { color: var(--color-on-surface); font-size: 16px; }
.status-pop {
  opacity: 0; transform: scale(0.5);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.status-pop.visible { opacity: 1; transform: scale(1); }

/* Alternative Results Accordion */
.alt-results { margin-top: var(--space-4); }
.alt-toggle {
  width: 100%; padding: var(--space-3) var(--space-4);
  background: var(--color-surface-container); border: 1px solid var(--border-muted);
  border-radius: var(--radius-md); cursor: pointer; font-family: inherit;
  font-size: 14px; font-weight: 500;
  display: flex; align-items: center; justify-content: space-between;
  transition: var(--transition);
}
.alt-toggle:hover { background: var(--border-muted); }
.alt-toggle .arrow { transition: transform 0.3s; }
.alt-toggle.open .arrow { transform: rotate(180deg); }
.alt-content {
  max-height: 0; overflow: hidden;
  transition: max-height 0.4s ease;
}
.alt-content.open { max-height: 2000px; }

/* Analyzing overlay */
.analyzing-overlay {
  display: none; align-items: center; justify-content: center;
  flex-direction: column; gap: var(--space-4);
  padding: 40px; text-align: center;
}
.analyzing-overlay.active { display: flex; }
.analyzing-spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--color-surface-container);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Calendar ===== */
.calendar-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: var(--space-4);
}
.calendar-nav { display: flex; align-items: center; gap: var(--space-3); }
.calendar-nav-btn {
  width: 36px; height: 36px; border: 1px solid var(--border-default);
  border-radius: var(--radius-sm); background: #fff; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition); font-size: 16px;
}
.calendar-nav-btn:hover { background: var(--color-surface-container); }
.calendar-month { font-size: 20px; font-weight: 700; }
.calendar-grid-wrapper {
  background: #fff; border: 1px solid var(--border-default);
  border-radius: var(--radius-md); overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.calendar-grid {
  display: grid; grid-template-columns: repeat(7, 1fr);
}
.calendar-day-header {
  padding: var(--space-3); text-align: center;
  font-size: 12px; font-weight: 600; color: var(--color-on-surface-variant);
  background: var(--color-surface-container);
  border-bottom: 1px solid var(--border-muted);
}
.calendar-day {
  min-height: 90px; padding: var(--space-2);
  border-bottom: 1px solid var(--border-muted);
  border-right: 1px solid var(--border-muted);
  cursor: pointer; transition: var(--transition);
  position: relative;
}
.calendar-day:nth-child(7n) { border-right: none; }
.calendar-day:hover { background: rgba(26,115,232,0.04); }
.calendar-day.other-month { background: var(--color-surface-container); opacity: 0.5; }
.calendar-day.today { background: rgba(26,115,232,0.06); }
.calendar-day-num { font-size: 13px; font-weight: 600; margin-bottom: var(--space-1); }
.calendar-day-status {
  font-size: 10px; padding: 2px 6px;
  border-radius: var(--radius-sm); display: inline-block;
}
.cal-ok { background: var(--color-success-muted); color: var(--color-success); }
.cal-warn { background: var(--color-warning-muted); color: var(--color-warning); }
.cal-danger { background: var(--color-danger-muted); color: var(--color-danger); }
.cal-off { background: var(--color-surface-container); color: var(--color-on-surface-variant); }
.calendar-day-people { font-size: 11px; color: var(--color-on-surface-variant); margin-top: 2px; }

/* Calendar Detail Panel */
.calendar-detail {
  display: none; margin-top: var(--space-4);
}
.calendar-detail.active { display: block; }

/* Calendar Mobile List */
.calendar-list { display: none; }
.calendar-list-item {
  background: #fff; border: 1px solid var(--border-default);
  border-radius: var(--radius-md); padding: var(--space-4);
  margin-bottom: var(--space-2); cursor: pointer;
  display: flex; align-items: center; gap: var(--space-4);
  transition: var(--transition);
}
.calendar-list-item:hover { box-shadow: var(--shadow-sm); }
.calendar-list-date {
  text-align: center; min-width: 50px;
}
.calendar-list-date .day-num { font-size: 22px; font-weight: 700; }
.calendar-list-date .day-name { font-size: 11px; color: var(--color-on-surface-variant); }
.calendar-list-info { flex: 1; }

/* ===== Shift Timeline (Gantt) ===== */
.shift-timeline {
  margin: var(--space-4) 0; padding: var(--space-3) 0;
  border-top: 1px solid var(--border-muted);
  overflow-x: auto; -webkit-overflow-scrolling: touch;
}
.timeline-inner { min-width: 500px; }
.timeline-axis {
  display: flex; padding-left: 90px; margin-bottom: var(--space-1);
  font-size: 11px; color: var(--color-on-surface-variant); position: relative; height: 18px;
}
.timeline-axis span {
  position: absolute; transform: translateX(-50%); white-space: nowrap;
}
.timeline-row {
  display: flex; align-items: center; height: 28px; margin-bottom: 2px;
}
.timeline-label {
  width: 85px; flex-shrink: 0; font-size: 12px; font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  padding-right: var(--space-2);
}
.timeline-track {
  flex: 1; position: relative; height: 20px;
  background: var(--color-surface-container); border-radius: var(--radius-sm);
}
.timeline-bar {
  position: absolute; top: 2px; bottom: 2px; border-radius: 3px;
  opacity: 0; transform: scaleX(0); transform-origin: left center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer; min-width: 4px;
}
.timeline-bar.visible { opacity: 1; transform: scaleX(1); }
.timeline-bar[data-dept="出荷・検品"]  { background: #93bbfc; }
.timeline-bar[data-dept="入荷・仕分け"] { background: #fcd98e; }
.timeline-bar[data-dept="物流・加工"]   { background: #86efac; }
.timeline-bar[data-dept="夜間作業"]     { background: #c4b5fd; }
.timeline-bar-tooltip {
  display: none; position: absolute; bottom: calc(100% + 4px); left: 50%;
  transform: translateX(-50%); padding: 4px 8px; background: #1a1a2e;
  color: #fff; font-size: 11px; border-radius: var(--radius-sm);
  white-space: nowrap; z-index: 10; pointer-events: none;
}
.timeline-bar:hover .timeline-bar-tooltip { display: block; }
.timeline-section-title {
  font-size: 12px; font-weight: 600; color: var(--color-on-surface-variant);
  margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);
}

/* ===== Dev Popup ===== */
.dev-popup {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: #fff; border-radius: var(--radius-lg); padding: var(--space-8);
  box-shadow: var(--shadow-lg); z-index: 300; text-align: center;
  max-width: 360px; width: 90%; animation: modalIn 0.3s ease;
}
.dev-popup-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4); z-index: 299;
}

/* ===== Screen Label ===== */
.screen-label {
  position: fixed; bottom: 16px; left: 16px;
  padding: 6px 14px; background: #1a1a2e;
  color: var(--color-primary-container); font-size: 11px;
  font-weight: 600; border-radius: var(--radius-full);
  z-index: 200; box-shadow: var(--shadow-md);
}

/* ===== Responsive ===== */
@media (max-width: 1024px) {
  .shift-gen-layout { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
  .nav { padding: 0 var(--space-3); }
  .nav-brand { margin-right: var(--space-3); font-size: 14px; }
  .nav-tab { padding: 14px 10px; font-size: 12px; }
  .nav-user { display: none; }
  .page { padding: var(--space-4); }
  .stats-grid { grid-template-columns: 1fr; }
  .stat-card { padding: var(--space-4); }
  .stat-value { font-size: 24px; }
  .staff-grid { grid-template-columns: 1fr; }
  .calendar-grid-wrapper { display: none; }
  .calendar-list { display: block; }
  .form-row { grid-template-columns: 1fr; }
  .shift-timeline { margin-left: -16px; margin-right: -16px; padding-left: 16px; }
}

@media (max-width: 480px) {
  .nav-brand span { display: none; }
  .page-title { font-size: 20px; }
  .modal { border-radius: 0; max-width: 100%; max-height: 100%; height: 100%; }
  .quick-actions { flex-direction: column; }
  .quick-actions .btn { width: 100%; justify-content: center; }
}

/* ===== Department Filter ===== */
.dept-filters {
  display: flex; flex-wrap: wrap; gap: var(--space-2);
  margin-bottom: var(--space-4);
}
.dept-filter {
  padding: var(--space-2) var(--space-4);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-full); font-size: 13px;
  cursor: pointer; transition: var(--transition);
  background: #fff; font-family: inherit;
}
.dept-filter.active { background: var(--color-primary); color: #fff; border-color: var(--color-primary); }
.dept-filter .dept-count {
  display: inline-flex; align-items: center; justify-content: center;
  min-width: 20px; height: 20px; border-radius: var(--radius-full);
  background: rgba(0,0,0,0.08); font-size: 11px; margin-left: 4px;
  padding: 0 5px;
}
.dept-filter.active .dept-count { background: rgba(255,255,255,0.25); }
.badge-dept {
  display: inline-block; padding: 1px 8px;
  border-radius: var(--radius-sm); font-size: 11px; font-weight: 500;
}
.badge-dept-a { background: #dbeafe; color: #1e40af; }
.badge-dept-b { background: #fef3c7; color: #92400e; }
.badge-dept-c { background: #d1fae5; color: #065f46; }
.badge-dept-d { background: #ede9fe; color: #5b21b6; }
.staff-count-info {
  font-size: 13px; color: var(--color-on-surface-variant);
  margin-bottom: var(--space-3);
}

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--color-on-surface-variant); }
</style>
</head>
<body>

<!-- ===== Navigation ===== -->
<nav class="nav">
  <div class="nav-brand">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
      <rect x="3" y="3" width="18" height="18" rx="4" stroke="#5b9aff" stroke-width="2"/>
      <path d="M7 12h10M7 8h6M7 16h8" stroke="#5b9aff" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>ShiftOptimizer AI</span>
  </div>
  <div class="nav-tabs-container">
    <div class="nav-tab active" data-page="dashboard">ダッシュボード</div>
    <div class="nav-tab" data-page="staff">スタッフ一覧</div>
    <div class="nav-tab" data-page="generate">シフト生成</div>
    <div class="nav-tab" data-page="calendar">カレンダー</div>
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-user"><div class="nav-avatar">村</div>村田さん</div>
</nav>

<!-- ===== Dashboard ===== -->
<div class="page active" id="page-dashboard">
  <div class="page-inner">
    <h1 class="page-title">ダッシュボード</h1>
    <p class="page-subtitle">シフト管理の概要</p>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">登録スタッフ</div>
        <div class="stat-value" id="stat-staff">8</div>
        <div class="stat-sub">全員アクティブ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">今週のシフト</div>
        <div class="stat-value">156</div>
        <div class="stat-sub">充足率 92%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">本日の出荷レベル</div>
        <div class="stat-value" style="color: var(--color-warning);">通常</div>
        <div class="stat-sub">必要スコア: 40</div>
      </div>
    </div>

    <div class="quick-actions">
      <button class="btn btn-primary btn-lg" onclick="switchPage('generate')">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 3v12M3 9h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        AIでシフトを生成
      </button>
      <button class="btn btn-secondary btn-lg" onclick="switchPage('staff')">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="6" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M3 16c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="currentColor" stroke-width="1.5"/></svg>
        スタッフ一覧
      </button>
    </div>

    <div class="today-summary">
      <div class="today-header">
        <div class="today-title">本日のシフトサマリー（早番）</div>
        <span class="badge badge-success" id="today-status">充足</span>
      </div>
      <div class="today-staff-list" id="today-staff-list"></div>
      <div class="today-score">
        <div class="score-bar-bg">
          <div class="score-bar-fill" id="today-score-bar" style="width: 0; background: var(--color-success);"></div>
        </div>
        <div class="score-info">
          <span id="today-score-text">スコア: 0 / 40</span>
          <span>通常レベル</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Staff List ===== -->
<div class="page" id="page-staff">
  <div class="page-inner">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:var(--space-2);margin-bottom:var(--space-2);">
      <h1 class="page-title" style="margin-bottom:0;">スタッフ一覧</h1>
      <button class="btn btn-primary" onclick="openStaffModal()">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        スタッフ追加
      </button>
    </div>
    <p class="page-subtitle">登録されているスタッフの情報を管理します</p>
    <div class="dept-filters" id="dept-filters">
      <button class="dept-filter active" data-dept="all" onclick="filterDept(this)">全て<span class="dept-count" id="count-all"></span></button>
      <button class="dept-filter" data-dept="出荷・検品" onclick="filterDept(this)">出荷・検品<span class="dept-count" id="count-a"></span></button>
      <button class="dept-filter" data-dept="入荷・仕分け" onclick="filterDept(this)">入荷・仕分け<span class="dept-count" id="count-b"></span></button>
      <button class="dept-filter" data-dept="物流・加工" onclick="filterDept(this)">物流・加工<span class="dept-count" id="count-c"></span></button>
      <button class="dept-filter" data-dept="夜間作業" onclick="filterDept(this)">夜間作業<span class="dept-count" id="count-d"></span></button>
    </div>
    <div class="staff-count-info" id="staff-count-info"></div>
    <div class="staff-grid" id="staff-grid"></div>
  </div>
</div>

<!-- ===== Shift Generator ===== -->
<div class="page" id="page-generate">
  <div class="page-inner">
    <h1 class="page-title">AIシフト生成</h1>
    <p class="page-subtitle">出荷量に応じた最適なシフトをAIが自動生成します</p>

    <div class="shift-gen-layout">
      <div class="shift-input-panel">
        <div class="card">
          <div class="card-header">入力条件</div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">日付</label>
              <input type="date" class="form-input shift-date-input" id="shift-date">
            </div>
            <div class="form-group">
              <label class="form-label">時間帯</label>
              <div class="slot-toggles" id="slot-toggles">
                <button class="slot-toggle active" data-slot="早番" onclick="selectSlot(this)">早番</button>
                <button class="slot-toggle" data-slot="遅番" onclick="selectSlot(this)">遅番</button>
                <button class="slot-toggle" data-slot="夜勤" onclick="selectSlot(this)">夜勤</button>
                <button class="slot-toggle" data-slot="通し" onclick="selectSlot(this)">通し</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">出荷量レベル</label>
              <div class="level-buttons" id="level-buttons">
                <button class="level-btn" data-level="軽量" onclick="selectLevel(this)">
                  <span class="level-name">軽量</span>
                  <span class="level-score">必要スコア: 20</span>
                </button>
                <button class="level-btn active" data-level="通常" onclick="selectLevel(this)">
                  <span class="level-name">通常</span>
                  <span class="level-score">必要スコア: 40</span>
                </button>
                <button class="level-btn" data-level="繁忙" onclick="selectLevel(this)">
                  <span class="level-name">繁忙</span>
                  <span class="level-score">必要スコア: 60</span>
                </button>
                <button class="level-btn" data-level="超繁忙" onclick="selectLevel(this)">
                  <span class="level-name">超繁忙</span>
                  <span class="level-score">必要スコア: 80</span>
                </button>
              </div>
            </div>

            <div class="shift-info-box" id="shift-info-box">
              <div class="shift-info-row">
                <span>必要スコア</span>
                <strong id="info-required-score">40</strong>
              </div>
              <div class="shift-info-row">
                <span>出勤可能スタッフ</span>
                <strong id="info-available-count">-</strong>
              </div>
            </div>

            <button class="btn btn-primary btn-generate" id="btn-generate" onclick="generateShift()">
              <span class="pulse"></span>
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 2l2.1 4.3 4.7.7-3.4 3.3.8 4.7L9 12.8 4.8 15l.8-4.7L2.2 7l4.7-.7L9 2z" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
              AIでシフト生成
            </button>
          </div>
        </div>
      </div>

      <div class="shift-results" id="shift-results">
        <div class="result-placeholder">
          <div class="result-placeholder-icon">&#128197;</div>
          <div style="font-size:16px;font-weight:600;margin-bottom:var(--space-2);">シフトを生成してください</div>
          <div>左の条件を設定し「AIでシフト生成」ボタンをクリック</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Calendar ===== -->
<div class="page" id="page-calendar">
  <div class="page-inner">
    <h1 class="page-title">シフトカレンダー</h1>
    <p class="page-subtitle">月間のシフト状況を一覧できます</p>

    <div class="calendar-header">
      <div class="calendar-nav">
        <button class="calendar-nav-btn" onclick="changeMonth(-1)">&lt;</button>
        <span class="calendar-month" id="calendar-month"></span>
        <button class="calendar-nav-btn" onclick="changeMonth(1)">&gt;</button>
      </div>
      <div>
        <span class="badge badge-success" style="margin-right:4px;">充足</span>
        <span class="badge badge-warning" style="margin-right:4px;">不足気味</span>
        <span class="badge badge-danger" style="margin-right:4px;">人員不足</span>
        <span class="badge badge-muted">休み</span>
      </div>
    </div>

    <div class="calendar-grid-wrapper">
      <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <div class="calendar-list" id="calendar-list"></div>

    <div class="calendar-detail" id="calendar-detail">
      <div class="card">
        <div class="card-header">
          <span id="detail-date">-</span>
          <button class="btn btn-sm btn-secondary" onclick="document.getElementById('calendar-detail').classList.remove('active')">閉じる</button>
        </div>
        <div class="card-body" id="detail-body"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Staff Edit Modal ===== -->
<div class="modal-overlay" id="staff-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">スタッフ追加</div>
      <button class="modal-close" onclick="closeStaffModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-staff-id">
      <div class="form-group">
        <label class="form-label">名前</label>
        <input type="text" class="form-input" id="edit-name" placeholder="例: 佐藤 浩司">
      </div>
      <div class="form-group">
        <label class="form-label">部署</label>
        <select class="form-select" id="edit-dept">
          <option value="出荷・検品">出荷・検品</option>
          <option value="入荷・仕分け">入荷・仕分け</option>
          <option value="物流・加工">物流・加工</option>
          <option value="夜間作業">夜間作業</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">スキルレベル（1-5）</label>
          <input type="number" class="form-input" id="edit-skill" min="1" max="5" value="3">
        </div>
        <div class="form-group">
          <label class="form-label">時給（円）</label>
          <input type="number" class="form-input" id="edit-rate" value="1050" step="50">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">貢献度（0.5-2.0）</label>
        <input type="number" class="form-input" id="edit-weight" min="0.5" max="2.0" step="0.1" value="1.0">
      </div>
      <div class="form-group">
        <label class="form-label">出勤可能曜日</label>
        <div class="checkbox-group" id="edit-days">
          <label class="checkbox-item"><input type="checkbox" value="月"> 月</label>
          <label class="checkbox-item"><input type="checkbox" value="火"> 火</label>
          <label class="checkbox-item"><input type="checkbox" value="水"> 水</label>
          <label class="checkbox-item"><input type="checkbox" value="木"> 木</label>
          <label class="checkbox-item"><input type="checkbox" value="金"> 金</label>
          <label class="checkbox-item"><input type="checkbox" value="土"> 土</label>
          <label class="checkbox-item"><input type="checkbox" value="日"> 日</label>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">出勤可能時間帯</label>
        <div class="checkbox-group" id="edit-slots">
          <label class="checkbox-item"><input type="checkbox" value="早番"> 早番</label>
          <label class="checkbox-item"><input type="checkbox" value="遅番"> 遅番</label>
          <label class="checkbox-item"><input type="checkbox" value="夜勤"> 夜勤</label>
          <label class="checkbox-item"><input type="checkbox" value="通し"> 通し</label>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">備考</label>
        <input type="text" class="form-input" id="edit-note" placeholder="例: フォークリフト資格">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeStaffModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveStaff()">保存</button>
    </div>
  </div>
</div>

<div class="screen-label" id="screen-label">DEMO: ダッシュボード</div>

<script>
/* ===== Sample Data (85名 — 実データの構造を再現、名前はすべてダミー) ===== */
// Compact format: [id, name, dept, skill, daysStr, slotsStr, rate, weight, note]
// dept: A=出荷・検品, B=入荷・仕分け, C=物流・加工, D=夜間作業
const _raw = [
  // === A: 出荷・検品（日勤）37名 ===
  ['a01','佐藤 浩司','A',5,'月火水木金','早遅',1200,2.0,'班長・フォークリフト資格'],
  ['a02','加藤 隆太','A',2,'土日','早',1000,0.7,'シフト制・不定期'],
  ['a03','鈴木 真理','A',4,'月火水木金','早',1100,1.4,'週5（土日祝休）'],
  ['a04','高橋 ナオミ','A',4,'月火水木金','早遅',1100,1.5,'週5（土日休）'],
  ['a05','伊藤 光男','A',1,'','',1000,0.3,'退職予定'],
  ['a06','マリア ロサ','A',3,'月火水木金土','早',1050,1.1,'シフト制'],
  ['a07','中村 亜希','A',3,'月火水木','早',1050,1.2,'週4（金土日祝休）'],
  ['a08','小林 和子','A',3,'月火水木金','早',1050,1.2,'週5（土日祝休）'],
  ['a09','松本 幸子','A',2,'月火水土','早',1000,0.9,'扶養内・シフト制'],
  ['a10','井上 恵美','A',3,'月水金','遅',1050,1.1,'週3（火木土日休）'],
  ['a11','木村 凛','A',2,'月火水','遅',1000,0.8,'扶養内・シフト制'],
  ['a12','林 奈美','A',3,'月火木金','早',1050,1.2,'週4（水土日祝休）'],
  ['a13','清水 修一','A',4,'月火木金','遅',1150,1.5,'週4（水土日休）'],
  ['a14','阿部 昌也','A',2,'木金','遅',1000,0.7,'週2（月火水土日休）'],
  ['a15','池田 龍','A',2,'月火水木','遅',1000,0.8,'扶養内・シフト制'],
  ['a16','橋本 聖月','A',1,'月火水','遅',1000,0.5,'扶養内・シフト制'],
  ['a17','小川 啓介','A',3,'月火水','遅',1050,1.0,'週3（木金土日休）'],
  ['a18','岡田 康介','A',2,'','遅',1000,0.7,'シフト制・不定期'],
  ['a19','後藤 壮太','A',3,'月火木金','遅',1050,1.1,'シフト制'],
  ['a20','近藤 優梨','A',3,'月火水木金土','早遅',1050,1.2,'シフト制'],
  ['a21','斎藤 美智代','A',4,'月火水木金','早',1100,1.4,'週5（土日休）'],
  ['a22','遠藤 房代','A',4,'月火水木金土','早遅',1100,1.5,'シフト制OK'],
  ['a23','太田 良有','A',4,'月火水金土日','早遅',1100,1.4,'週5（水木休）'],
  ['a24','三浦 怜美','A',2,'月火木金','早',1000,0.9,'週3-4（土日祝休）'],
  ['a25','原田 義一','A',4,'月火水木金','早遅',1150,1.6,'週5（土日祝休）'],
  ['a26','中川 明宣','A',3,'月火水木金','早遅',1050,1.3,'週5（土日祝休）'],
  ['a27','小野 健太','A',2,'火水木土','早',1000,0.8,'シフト制OK'],
  ['a28','グエン コンホア','A',3,'水木金','早遅',1050,1.1,'週3（月火土日祝休）'],
  ['a29','横山 理起','A',3,'月火水木金','早遅',1050,1.3,'週5（土日祝休）'],
  ['a30','千葉 真希','A',2,'火水木','早',1000,0.9,'週3（月金土日休）'],
  ['a31','菅原 將浩','A',3,'月木金','遅',1050,1.0,'週3（火水土日休）'],
  ['a32','市川 秀雄','A',4,'月火水木金土','早遅',1150,1.6,'週5（土日休）'],
  ['a33','水野 享子','A',3,'月火木金','早',1050,1.2,'週4（水土日祝休）'],
  ['a34','小松 裕香','A',4,'月火水木金','早遅',1100,1.4,'週5（土日祝休）'],
  ['a35','岩田 愛','A',3,'月火水木金','早遅',1050,1.3,'週5（土日祝休）'],
  ['a36','高木 衿香','A',2,'木金','早',1000,0.8,'週4-5（シフト制）'],
  ['a37','中島 藤子','A',1,'木','早',1000,0.4,'単発'],
  // === B: 入荷・仕分け（日勤）12名 ===
  ['b01','大野 貴之','B',5,'月火水木金','早遅',1200,2.0,'リーダー・フォークリフト'],
  ['b02','河野 絵里香','B',4,'月火水木金土','早遅',1100,1.5,'週5（日月休）'],
  ['b03','丸山 一希','B',4,'火水木金土','早遅',1100,1.5,'週5（日月休）'],
  ['b04','内田 智之','B',4,'月火水木金','早遅',1100,1.5,'週5（土日休）'],
  ['b05','杉山 和恵','B',2,'火水金','早',1000,0.9,'週3（月木土日休）'],
  ['b06','今井 早希','B',2,'月水木金','早',1000,0.9,'週4（水土日休）'],
  ['b07','永田 泰葉','B',2,'月水金','早',1000,0.8,'週3（火木土日休）'],
  ['b08','野口 雅彰','B',4,'月火水木金','早遅',1150,1.6,'週5（土日休）'],
  ['b09','片山 浩一','B',4,'月火水木金','早遅',1100,1.4,'週5（土日休）'],
  ['b10','大石 久仁子','B',3,'月水木金土','遅',1050,1.2,'週5（火日休）'],
  ['b11','柳田 和彦','B',3,'月木金','遅',1050,1.0,'週3（火木土日休）'],
  ['b12','平野 正和','B',3,'月火水木金','早遅',1050,1.3,'週5（土日休）'],
  // === C: 物流・加工 23名 ===
  ['c01','堀内 真司','C',4,'月火水木金土','遅',1150,1.5,'週5（土日休）'],
  ['c02','日野 雅則','C',4,'月火水木金','早遅',1100,1.5,'週5（金土休）'],
  ['c03','赤木 茂','C',5,'月水木金土日','早遅',1200,1.8,'週6（火休）'],
  ['c04','黒田 香','C',3,'月水木日','早',1050,1.1,'週4（火金土休）'],
  ['c05','白石 涼','C',3,'月水木日','早',1050,1.1,'週4（火金土休）'],
  ['c06','相田 恵里','C',3,'月水木日','早',1050,1.0,'週4（火金土休）'],
  ['c07','星野 雪江','C',3,'月水木日','早',1050,1.0,'週4（火金土休）'],
  ['c08','望月 章人','C',4,'月火水木金','早遅',1100,1.4,'週5（土日休）'],
  ['c09','宮内 遼太','C',3,'月火水木金土','早',1050,1.2,'週4（月土日休）'],
  ['c10','手塚 裕貴','C',3,'月水木日','早',1050,1.0,'週4（火金土休）'],
  ['c11','相沢 照美','C',3,'月火水木','早遅',1050,1.1,'週5（金土休）'],
  ['c12','吉川 みちよ','C',3,'月火水木','早遅',1050,1.0,'週5（金土休）'],
  ['c13','野村 健太郎','C',3,'月火木金','早',1050,1.1,'週4（水土日休）'],
  ['c14','栗原 仁志','C',2,'火土日','早',1000,0.8,'週3'],
  ['c15','戸田 幸治','C',3,'火水木土','早',1050,1.1,'週3-4（月金土休）'],
  ['c16','須藤 彩香','C',3,'月火木日','早',1050,1.1,'週4（月水土休）'],
  ['c17','金子 誠','C',4,'水木金日','早遅',1100,1.4,'水木金（日=月2回）'],
  ['c18','宇野 篤','C',4,'月火水木金土','早遅',1150,1.6,'週5-6（土休）'],
  ['c19','矢野 直人','C',3,'月火水木金','早遅',1050,1.3,'週5（土日休）'],
  ['c20','川村 尚記','C',3,'月火水木','早遅',1050,1.2,'週5（金土休）'],
  ['c21','植田 昭男','C',3,'月火水木','早遅',1050,1.2,'週5（金土休）'],
  ['c22','塚本 章賢','C',3,'月火水木','早遅',1050,1.1,'週3-4（金土休）'],
  ['c23','奥村 知之','C',2,'火木日','早',1000,0.8,'週3（月水金土休）'],
  // === D: 夜間作業 13名 ===
  ['d01','柏木 太輔','D',3,'金土','夜',1250,1.1,'週2（金土出勤）'],
  ['d02','新井 梓','D',4,'月火水木金','夜',1300,1.5,'週5（金土休）'],
  ['d03','土井 優','D',4,'月火水木金','夜',1300,1.5,'週5（金土休）'],
  ['d04','梅田 彩','D',3,'月火金木','夜',1250,1.2,'週4（水木土休）・隔週木出勤'],
  ['d05','栄 裕嗣','D',3,'火木日','夜',1250,1.1,'週3（火木日出勤）'],
  ['d06','桜井 均','D',2,'','夜',1200,0.6,'不定期'],
  ['d07','根本 ヒロノブ','D',2,'','夜',1200,0.6,'不定期'],
  ['d08','梶山 美幸','D',4,'月火水木金','夜',1300,1.5,'週5（土日休）'],
  ['d09','芦田 都','D',3,'月水木日','夜',1250,1.1,'週4（火金土休）'],
  ['d10','石橋 豊','D',2,'','夜',1200,0.6,'不定期'],
  ['d11','真田 秀人','D',4,'月火水木','夜',1300,1.4,'週5（金土休）'],
  ['d12','福島 弥生','D',3,'月水木日','夜',1250,1.1,'週4（火金土休）'],
  ['d13','桐山 宏','D',3,'','夜',1250,0.9,'不定期']
];

const deptMap = { A:'出荷・検品', B:'入荷・仕分け', C:'物流・加工', D:'夜間作業' };
const deptClassMap = { '出荷・検品':'badge-dept-a', '入荷・仕分け':'badge-dept-b', '物流・加工':'badge-dept-c', '夜間作業':'badge-dept-d' };
const slotExpand = { '早':'早番', '遅':'遅番', '夜':'夜勤', '通':'通し' };

const staffData = _raw.map(r => {
  const days = r[4] ? r[4].split('').reduce((a,c) => { if('月火水木金土日'.includes(c)) a.push(c); return a; }, []) : [];
  const slots = r[5] ? r[5].split('').reduce((a,c) => { if(slotExpand[c] && !a.includes(slotExpand[c])) a.push(slotExpand[c]); return a; }, []) : [];
  return { id:r[0], name:r[1], dept:deptMap[r[2]], skillLevel:r[3], availableDays:days, availableSlots:slots, hourlyRate:r[6], weight:r[7], note:r[8] };
});

let currentDeptFilter = 'all';

const shipmentLevels = {
  '軽量': { minScore: 20,  desc: '出荷少なめ' },
  '通常': { minScore: 40,  desc: '平均的な出荷量' },
  '繁忙': { minScore: 60, desc: '出荷多め' },
  '超繁忙': { minScore: 80, desc: '最大出荷' }
};

const dayNames = ['日','月','火','水','木','金','土'];
let currentMonth = new Date();

// Pre-generated calendar shift data
const calendarShifts = {};

/* ===== Navigation ===== */
const screenLabels = {
  dashboard: 'DEMO: ダッシュボード',
  staff: 'DEMO: スタッフ一覧',
  generate: 'DEMO: AIシフト生成',
  calendar: 'DEMO: シフトカレンダー'
};

function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if (el) el.classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => {
    if (t.dataset.page === page) t.classList.add('active');
  });
  document.getElementById('screen-label').textContent = screenLabels[page] || 'DEMO';
}

document.querySelectorAll('.nav-tab').forEach(t => {
  t.addEventListener('click', () => switchPage(t.dataset.page));
});

/* ===== Staff Rendering ===== */
function renderStars(level) {
  let html = '<span class="skill-stars">';
  for (let i = 1; i <= 5; i++) {
    html += '<span class="skill-star' + (i <= level ? ' filled' : '') + '">&#9733;</span>';
  }
  return html + '</span>';
}

function filterDept(el) {
  document.querySelectorAll('.dept-filter').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  currentDeptFilter = el.dataset.dept;
  renderStaffGrid();
}

function getFilteredStaff() {
  if (currentDeptFilter === 'all') return staffData;
  return staffData.filter(s => s.dept === currentDeptFilter);
}

function updateDeptCounts() {
  document.getElementById('count-all').textContent = staffData.length;
  const counts = {};
  staffData.forEach(s => { counts[s.dept] = (counts[s.dept] || 0) + 1; });
  document.getElementById('count-a').textContent = counts['出荷・検品'] || 0;
  document.getElementById('count-b').textContent = counts['入荷・仕分け'] || 0;
  document.getElementById('count-c').textContent = counts['物流・加工'] || 0;
  document.getElementById('count-d').textContent = counts['夜間作業'] || 0;
}

function renderStaffGrid() {
  const filtered = getFilteredStaff();
  const grid = document.getElementById('staff-grid');
  document.getElementById('staff-count-info').textContent = '表示: ' + filtered.length + '名 / 全' + staffData.length + '名';
  grid.innerHTML = filtered.map(s => {
    const deptClass = deptClassMap[s.dept] || 'badge-dept-a';
    const dayBadges = s.availableDays.map(d => '<span class="badge badge-primary" style="font-size:11px;">' + d + '</span>').join('');
    const slotBadges = s.availableSlots.map(sl => '<span class="badge badge-muted" style="font-size:11px;">' + sl + '</span>').join('');
    return '<div class="staff-card" onclick="openStaffModal(\'' + s.id + '\')">' +
      '<div class="staff-card-header">' +
        '<div class="staff-avatar">' + s.name.charAt(0) + '</div>' +
        '<div><div class="staff-name">' + s.name + ' <span class="badge-dept ' + deptClass + '">' + s.dept + '</span></div>' +
        '<div class="staff-meta">' + renderStars(s.skillLevel) + ' Lv.' + s.skillLevel + '</div></div>' +
      '</div>' +
      '<div class="staff-badges">' + dayBadges + '</div>' +
      '<div class="staff-badges">' + slotBadges + '</div>' +
      '<div class="staff-rate">&#165;' + s.hourlyRate.toLocaleString() + '/時 &#12288;貢献度: ' + s.weight + '</div>' +
      (s.note ? '<div class="staff-note">' + s.note + '</div>' : '') +
    '</div>';
  }).join('');
  document.getElementById('stat-staff').textContent = staffData.length;
  updateDeptCounts();
}

/* ===== Staff Modal ===== */
function openStaffModal(id) {
  const modal = document.getElementById('staff-modal');
  if (id) {
    const s = staffData.find(x => x.id === id);
    if (!s) return;
    document.getElementById('modal-title').textContent = 'スタッフ編集';
    document.getElementById('edit-staff-id').value = s.id;
    document.getElementById('edit-name').value = s.name;
    document.getElementById('edit-dept').value = s.dept || '出荷・検品';
    document.getElementById('edit-skill').value = s.skillLevel;
    document.getElementById('edit-rate').value = s.hourlyRate;
    document.getElementById('edit-weight').value = s.weight;
    document.getElementById('edit-note').value = s.note || '';
    document.querySelectorAll('#edit-days input').forEach(cb => { cb.checked = s.availableDays.includes(cb.value); });
    document.querySelectorAll('#edit-slots input').forEach(cb => { cb.checked = s.availableSlots.includes(cb.value); });
  } else {
    document.getElementById('modal-title').textContent = 'スタッフ追加';
    document.getElementById('edit-staff-id').value = '';
    document.getElementById('edit-name').value = '';
    document.getElementById('edit-dept').value = '出荷・検品';
    document.getElementById('edit-skill').value = 3;
    document.getElementById('edit-rate').value = 1050;
    document.getElementById('edit-weight').value = 1.0;
    document.getElementById('edit-note').value = '';
    document.querySelectorAll('#edit-days input').forEach(cb => { cb.checked = false; });
    document.querySelectorAll('#edit-slots input').forEach(cb => { cb.checked = false; });
  }
  modal.classList.add('active');
}

function closeStaffModal() {
  document.getElementById('staff-modal').classList.remove('active');
}

function saveStaff() {
  const id = document.getElementById('edit-staff-id').value;
  const name = document.getElementById('edit-name').value.trim();
  if (!name) { alert('名前を入力してください'); return; }
  const days = [];
  document.querySelectorAll('#edit-days input:checked').forEach(cb => days.push(cb.value));
  const slots = [];
  document.querySelectorAll('#edit-slots input:checked').forEach(cb => slots.push(cb.value));
  const obj = {
    name: name,
    dept: document.getElementById('edit-dept').value,
    skillLevel: parseInt(document.getElementById('edit-skill').value) || 3,
    availableDays: days,
    availableSlots: slots,
    hourlyRate: parseInt(document.getElementById('edit-rate').value) || 1050,
    weight: parseFloat(document.getElementById('edit-weight').value) || 1.0,
    note: document.getElementById('edit-note').value.trim()
  };
  if (id) {
    const idx = staffData.findIndex(x => x.id === id);
    if (idx >= 0) Object.assign(staffData[idx], obj);
  } else {
    obj.id = 's' + (staffData.length + 1) + '_' + Date.now();
    staffData.push(obj);
  }
  closeStaffModal();
  renderStaffGrid();
  updateShiftInfo();
}

/* ===== Shift Generation ===== */
let selectedSlot = '早番';
let selectedLevel = '通常';

function selectSlot(el) {
  document.querySelectorAll('.slot-toggle').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedSlot = el.dataset.slot;
  updateShiftInfo();
}

function selectLevel(el) {
  document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedLevel = el.dataset.level;
  document.getElementById('info-required-score').textContent = shipmentLevels[selectedLevel].minScore;
  updateShiftInfo();
}

function getSelectedDate() {
  const val = document.getElementById('shift-date').value;
  return val ? new Date(val) : new Date();
}

function getDayName(date) {
  return dayNames[date.getDay()];
}

function getAvailableStaff(date, slot) {
  const day = getDayName(date);
  return staffData.filter(s => s.availableDays.includes(day) && s.availableSlots.includes(slot));
}

function updateShiftInfo() {
  const date = getSelectedDate();
  const available = getAvailableStaff(date, selectedSlot);
  document.getElementById('info-available-count').textContent = available.length + '名';
}

// Algorithm A: Efficiency (skill*weight descending)
function algoEfficiency(available, minScore) {
  const sorted = [...available].sort((a, b) => (b.skillLevel * b.weight) - (a.skillLevel * a.weight));
  const selected = [];
  let total = 0;
  for (const s of sorted) {
    if (total >= minScore) break;
    selected.push(s);
    total += s.skillLevel * s.weight;
  }
  return { staff: selected, totalScore: total, status: total >= minScore ? '充足' : '人員不足' };
}

// Algorithm B: Cost-minimum (hourly rate ascending)
function algoCostMin(available, minScore) {
  const sorted = [...available].sort((a, b) => a.hourlyRate - b.hourlyRate);
  const selected = [];
  let total = 0;
  for (const s of sorted) {
    if (total >= minScore) break;
    selected.push(s);
    total += s.skillLevel * s.weight;
  }
  return { staff: selected, totalScore: total, status: total >= minScore ? '充足' : '人員不足' };
}

// Algorithm C: Balanced (1 veteran + skill-diversified)
function algoBalanced(available, minScore) {
  const sorted = [...available].sort((a, b) => (b.skillLevel * b.weight) - (a.skillLevel * a.weight));
  const selected = [];
  let total = 0;
  // Pick top veteran first
  if (sorted.length > 0) {
    selected.push(sorted[0]);
    total += sorted[0].skillLevel * sorted[0].weight;
  }
  // Fill remaining by alternating high/low skill
  const remaining = sorted.slice(1);
  const low = remaining.filter(s => s.skillLevel <= 3);
  const high = remaining.filter(s => s.skillLevel > 3);
  let useHigh = false;
  while (total < minScore && (low.length > 0 || high.length > 0)) {
    const pool = useHigh ? (high.length > 0 ? high : low) : (low.length > 0 ? low : high);
    if (pool.length === 0) break;
    const pick = pool.shift();
    selected.push(pick);
    total += pick.skillLevel * pick.weight;
    useHigh = !useHigh;
  }
  return { staff: selected, totalScore: total, status: total >= minScore ? '充足' : '人員不足' };
}

function calcCost(staff, slot) {
  const hours = slot === '通し' ? 8 : 4;
  return staff.reduce((sum, s) => sum + s.hourlyRate * hours, 0);
}

/* ===== Staff Hours & Timeline ===== */
function getStaffHours(staff, slot) {
  const isFulltime = staff.availableDays.length >= 5;
  const isFuyounai = (staff.note && staff.note.includes('扶養内')) || (staff.hourlyRate <= 1000 && staff.availableDays.length <= 3);
  switch(slot) {
    case '早番':
      if (isFulltime && staff.skillLevel >= 4) return { start: 7.75, end: 16.75 };
      if (isFulltime) return { start: 8, end: 17 };
      if (isFuyounai) return { start: 9.5, end: 13.5 };
      return { start: 9, end: 15 };
    case '遅番':
      if (isFuyounai) return { start: 17, end: 21 };
      if (isFulltime) return { start: 15, end: 22 };
      return { start: 17, end: 22 };
    case '夜勤':
      if (staff.weight >= 1.4) return { start: 22, end: 31 }; // 翌7:00
      if (staff.weight >= 1.0) return { start: 22.5, end: 30.5 }; // 翌6:30
      return { start: 23, end: 30 }; // 翌6:00
    case '通し':
      return { start: 8, end: 22 };
    default:
      return { start: 8, end: 17 };
  }
}

function formatHour(h) {
  const hour = Math.floor(h % 24);
  const min = Math.round((h % 1) * 60);
  return hour + ':' + String(min).padStart(2, '0');
}

function getTimelineRange(slot) {
  switch(slot) {
    case '早番': return { min: 6, max: 18 };
    case '遅番': return { min: 14, max: 25 };
    case '夜勤': return { min: 20, max: 32 };
    case '通し': return { min: 6, max: 24 };
    default: return { min: 6, max: 18 };
  }
}

function buildTimelineHTML(staffList, slot) {
  const range = getTimelineRange(slot);
  const span = range.max - range.min;

  // Build axis labels
  let axisHTML = '';
  for (let h = range.min; h <= range.max; h += 2) {
    const pct = ((h - range.min) / span) * 100;
    const label = h >= 24 ? formatHour(h - 24) : formatHour(h);
    axisHTML += '<span style="left:' + pct + '%">' + label + '</span>';
  }

  // Build rows
  let rowsHTML = '';
  staffList.forEach(s => {
    const hours = getStaffHours(s, slot);
    const leftPct = Math.max(((hours.start - range.min) / span) * 100, 0);
    const widthPct = Math.min(((hours.end - hours.start) / span) * 100, 100 - leftPct);
    const startLabel = formatHour(hours.start);
    const endLabel = hours.end >= 24 ? formatHour(hours.end - 24) : formatHour(hours.end);

    rowsHTML += '<div class="timeline-row">' +
      '<div class="timeline-label">' + s.name + '</div>' +
      '<div class="timeline-track">' +
        '<div class="timeline-bar" data-dept="' + s.dept + '" style="left:' + leftPct + '%;width:' + widthPct + '%;">' +
          '<div class="timeline-bar-tooltip">' + s.name + ' ' + startLabel + '-' + endLabel + '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  });

  return '<div class="shift-timeline">' +
    '<div class="timeline-section-title"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="1" y="3" width="12" height="8" rx="1" stroke="currentColor" stroke-width="1.2"/><path d="M1 6h12M4 3v8M8 3v8" stroke="currentColor" stroke-width="1" opacity="0.4"/></svg> タイムライン</div>' +
    '<div class="timeline-inner">' +
      '<div class="timeline-axis">' + axisHTML + '</div>' +
      rowsHTML +
    '</div>' +
  '</div>';
}

/* ===== Dev Popup (Excel等) ===== */
function showDevPopup() {
  const overlay = document.createElement('div');
  overlay.className = 'dev-popup-overlay';
  const popup = document.createElement('div');
  popup.className = 'dev-popup';
  popup.innerHTML = '<div style="font-size:36px;margin-bottom:var(--space-3);">&#128679;</div>' +
    '<div style="font-size:16px;font-weight:700;margin-bottom:var(--space-2);">開発中の機能です</div>' +
    '<div style="font-size:13px;color:var(--color-on-surface-variant);margin-bottom:var(--space-6);">Excel出力機能は現在開発中のため、まだご利用いただけません。本番リリース時にご利用可能になります。</div>' +
    '<button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="closeDevPopup()">閉じる</button>';
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  overlay.addEventListener('click', closeDevPopup);
}

function closeDevPopup() {
  const overlay = document.querySelector('.dev-popup-overlay');
  const popup = document.querySelector('.dev-popup');
  if (overlay) overlay.remove();
  if (popup) popup.remove();
}

function generateShift() {
  const btn = document.getElementById('btn-generate');
  const results = document.getElementById('shift-results');
  const date = getSelectedDate();
  const minScore = shipmentLevels[selectedLevel].minScore;
  const available = getAvailableStaff(date, selectedSlot);

  // Pulse animation
  btn.classList.add('animating');
  btn.disabled = true;
  setTimeout(() => btn.classList.remove('animating'), 600);

  // Show analyzing
  results.innerHTML = '<div class="analyzing-overlay active"><div class="analyzing-spinner"></div><div style="font-weight:600;">AIが最適シフトを分析中...</div></div>';

  setTimeout(() => {
    const resultA = algoEfficiency(available, minScore);
    const resultB = algoCostMin(available, minScore);
    const resultC = algoBalanced(available, minScore);
    const costA = calcCost(resultA.staff, selectedSlot);
    const costB = calcCost(resultB.staff, selectedSlot);
    const costC = calcCost(resultC.staff, selectedSlot);

    const dateStr = date.getFullYear() + '/' + (date.getMonth()+1) + '/' + date.getDate() + ' (' + getDayName(date) + ')';

    results.innerHTML = buildResultHTML('A', '推奨案（効率重視）', resultA, costA, minScore, dateStr, true) +
      '<div class="alt-results" style="opacity:0;transform:translateY(10px);transition:all 0.4s ease;">' +
        '<button class="alt-toggle" onclick="toggleAlt(this)">代替案を表示（コスト最小・バランス重視）<span class="arrow">&#9660;</span></button>' +
        '<div class="alt-content">' +
          buildResultHTML('B', 'コスト最小案', resultB, costB, minScore, dateStr, false) +
          buildResultHTML('C', 'バランス重視案', resultC, costC, minScore, dateStr, false) +
        '</div>' +
      '</div>';

    // Stagger animations
    setTimeout(() => {
      // Score gauge fill
      const gauge = results.querySelector('.score-gauge-fill');
      if (gauge) {
        const pct = Math.min((resultA.totalScore / minScore) * 100, 100);
        gauge.style.width = pct + '%';
        gauge.style.background = resultA.status === '充足' ? 'var(--color-success)' : 'var(--color-danger)';
      }
    }, 200);

    // Staff chips appear one by one
    const chips = results.querySelectorAll('.primary-result .result-staff-chip');
    chips.forEach((chip, i) => {
      setTimeout(() => chip.classList.add('visible'), 300 + i * 150);
    });

    // Timeline bars animate in after chips
    const bars = results.querySelectorAll('.primary-result .timeline-bar');
    const chipsEnd = 300 + chips.length * 150;
    bars.forEach((bar, i) => {
      setTimeout(() => bar.classList.add('visible'), chipsEnd + i * 200);
    });
    const barsEnd = chipsEnd + bars.length * 200;

    // Status badge pop
    setTimeout(() => {
      const statusBadge = results.querySelector('.primary-result .status-pop');
      if (statusBadge) statusBadge.classList.add('visible');
    }, barsEnd + 200);

    // Cost fade in
    setTimeout(() => {
      const costEl = results.querySelector('.primary-result .result-cost');
      if (costEl) { costEl.style.opacity = '0'; costEl.style.transition = 'opacity 0.4s ease'; setTimeout(() => costEl.style.opacity = '1', 50); }
    }, barsEnd + 400);

    // Alt results slide in
    setTimeout(() => {
      const altResults = results.querySelector('.alt-results');
      if (altResults) { altResults.style.opacity = '1'; altResults.style.transform = 'translateY(0)'; }
    }, barsEnd + 700);

    btn.disabled = false;
  }, 800);
}

function buildResultHTML(label, title, result, cost, minScore, dateStr, isPrimary) {
  const pct = Math.min((result.totalScore / minScore) * 100, 100);
  const statusClass = result.status === '充足' ? 'badge-success' : 'badge-danger';
  const gaugeColor = result.status === '充足' ? 'var(--color-success)' : 'var(--color-danger)';
  const targetPct = (minScore / (minScore * 1.5)) * 100;
  const hours = selectedSlot === '通し' ? 8 : 4;

  const staffChips = result.staff.map(s =>
    '<div class="result-staff-chip' + (isPrimary ? '' : ' visible') + '">' +
      '<span class="chip-avatar">' + s.name.charAt(0) + '</span>' +
      '<span>' + s.name + '</span>' +
      '<span style="font-size:11px;color:var(--color-on-surface-variant);">Lv.' + s.skillLevel + '</span>' +
    '</div>'
  ).join('');

  return '<div class="result-card' + (isPrimary ? ' primary primary-result' : '') + '">' +
    '<div class="result-card-header">' +
      '<div class="result-card-title">' +
        '<span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:var(--color-primary);color:#fff;font-size:12px;font-weight:700;">' + label + '</span> ' +
        title +
      '</div>' +
      '<span class="badge ' + statusClass + ' status-pop' + (isPrimary ? '' : ' visible') + '">' + result.status + '</span>' +
    '</div>' +
    '<div class="result-card-body">' +
      '<div style="font-size:12px;color:var(--color-on-surface-variant);margin-bottom:var(--space-3);">' + dateStr + ' / ' + selectedSlot + ' / ' + selectedLevel + '</div>' +
      '<div class="result-score-section">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:var(--space-1);font-size:13px;">' +
          '<span>スコア: <strong>' + result.totalScore.toFixed(1) + '</strong> / ' + minScore + '</span>' +
          '<span>' + result.staff.length + '名配置</span>' +
        '</div>' +
        '<div class="score-gauge-bg">' +
          '<div class="score-gauge-fill" style="width:' + (isPrimary ? '0' : pct + '%') + ';background:' + gaugeColor + ';"></div>' +
          '<div class="score-gauge-target" style="left:' + targetPct + '%;"></div>' +
        '</div>' +
      '</div>' +
      '<div class="result-staff-grid">' + staffChips + '</div>' +
      (isPrimary ? buildTimelineHTML(result.staff, selectedSlot) : '') +
      '<div class="result-cost">' +
        '<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:var(--space-2);">' +
          '<span>人件費概算（' + hours + '時間）: <strong>&#165;' + cost.toLocaleString() + '</strong></span>' +
          (isPrimary ? '<button class="btn btn-sm btn-secondary" onclick="showDevPopup()"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M3 12h8M5 8v4M9 8v4M3 4l4-2 4 2v4H3V4z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg> Excel出力</button>' : '') +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function toggleAlt(btn) {
  btn.classList.toggle('open');
  btn.nextElementSibling.classList.toggle('open');
}

/* ===== Calendar ===== */
function generateCalendarData() {
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const key = formatDateKey(date);
    const dayOfWeek = date.getDay();

    if (dayOfWeek === 0) {
      calendarShifts[key] = { status: '休み', people: 0, score: 0, level: '-' };
      continue;
    }

    // Simulate shift data
    const levels = ['軽量', '通常', '通常', '繁忙', '通常'];
    const level = levels[d % levels.length];
    const minScore = shipmentLevels[level].minScore;
    const available = getAvailableStaff(date, '早番');
    const result = algoEfficiency(available, minScore);

    calendarShifts[key] = {
      status: result.status === '充足' ? '確定' : (result.totalScore >= minScore * 0.7 ? '仮' : '人員不足'),
      people: result.staff.length,
      score: result.totalScore,
      level: level,
      staff: result.staff
    };
  }
}

function formatDateKey(date) {
  return date.getFullYear() + '-' + String(date.getMonth()+1).padStart(2,'0') + '-' + String(date.getDate()).padStart(2,'0');
}

function renderCalendar() {
  generateCalendarData();
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  document.getElementById('calendar-month').textContent = year + '年 ' + (month+1) + '月';

  const grid = document.getElementById('calendar-grid');
  let html = '';

  // Day headers
  dayNames.forEach(d => { html += '<div class="calendar-day-header">' + d + '</div>'; });

  // First day offset
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const prevMonthDays = new Date(year, month, 0).getDate();
  const today = new Date();

  // Previous month days
  for (let i = firstDay - 1; i >= 0; i--) {
    html += '<div class="calendar-day other-month"><div class="calendar-day-num">' + (prevMonthDays - i) + '</div></div>';
  }

  // Current month days
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const key = formatDateKey(date);
    const shift = calendarShifts[key];
    const isToday = date.toDateString() === today.toDateString();

    let statusClass = 'cal-off';
    let statusText = '休み';
    if (shift) {
      if (shift.status === '確定') { statusClass = 'cal-ok'; statusText = '充足'; }
      else if (shift.status === '仮') { statusClass = 'cal-warn'; statusText = '不足気味'; }
      else if (shift.status === '人員不足') { statusClass = 'cal-danger'; statusText = '人員不足'; }
      else { statusClass = 'cal-off'; statusText = '休み'; }
    }

    html += '<div class="calendar-day' + (isToday ? ' today' : '') + '" onclick="showCalendarDetail(\'' + key + '\',' + d + ')">' +
      '<div class="calendar-day-num">' + d + '</div>' +
      '<div class="calendar-day-status ' + statusClass + '">' + statusText + '</div>' +
      (shift && shift.people > 0 ? '<div class="calendar-day-people">' + shift.people + '名</div>' : '') +
    '</div>';
  }

  // Next month days
  const totalCells = firstDay + daysInMonth;
  const remaining = (7 - totalCells % 7) % 7;
  for (let i = 1; i <= remaining; i++) {
    html += '<div class="calendar-day other-month"><div class="calendar-day-num">' + i + '</div></div>';
  }

  grid.innerHTML = html;

  // Render mobile list
  renderCalendarList(year, month, daysInMonth);
}

function renderCalendarList(year, month, daysInMonth) {
  const list = document.getElementById('calendar-list');
  let html = '';

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const key = formatDateKey(date);
    const shift = calendarShifts[key];
    const dayName = dayNames[date.getDay()];

    let statusBadge = '<span class="badge badge-muted">休み</span>';
    if (shift && shift.status === '確定') statusBadge = '<span class="badge badge-success">充足</span>';
    else if (shift && shift.status === '仮') statusBadge = '<span class="badge badge-warning">不足気味</span>';
    else if (shift && shift.status === '人員不足') statusBadge = '<span class="badge badge-danger">人員不足</span>';

    html += '<div class="calendar-list-item" onclick="showCalendarDetail(\'' + key + '\',' + d + ')">' +
      '<div class="calendar-list-date"><div class="day-num">' + d + '</div><div class="day-name">' + dayName + '</div></div>' +
      '<div class="calendar-list-info">' +
        '<div style="display:flex;align-items:center;gap:8px;">' + statusBadge +
          (shift && shift.people > 0 ? '<span style="font-size:13px;">' + shift.people + '名 / ' + shift.level + '</span>' : '') +
        '</div>' +
      '</div>' +
    '</div>';
  }

  list.innerHTML = html;
}

function showCalendarDetail(key, day) {
  const shift = calendarShifts[key];
  const detail = document.getElementById('calendar-detail');
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth() + 1;

  document.getElementById('detail-date').textContent = year + '/' + month + '/' + day + ' のシフト詳細';

  if (!shift || shift.status === '休み') {
    document.getElementById('detail-body').innerHTML = '<p style="color:var(--color-on-surface-variant);">この日は休業日です。</p>';
  } else {
    let staffHTML = '';
    if (shift.staff && shift.staff.length > 0) {
      staffHTML = '<div style="margin-top:var(--space-3);"><strong>配置スタッフ:</strong></div>' +
        '<div style="display:flex;flex-wrap:wrap;gap:var(--space-2);margin-top:var(--space-2);">' +
        shift.staff.map(s => '<span class="badge badge-primary" style="padding:4px 12px;">' + s.name + ' (Lv.' + s.skillLevel + ')</span>').join('') +
        '</div>';
    }

    document.getElementById('detail-body').innerHTML =
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-4);">' +
        '<div><div class="stat-label">出荷レベル</div><div style="font-weight:600;font-size:16px;">' + shift.level + '</div></div>' +
        '<div><div class="stat-label">ステータス</div><div><span class="badge ' + (shift.status === '確定' ? 'badge-success' : shift.status === '仮' ? 'badge-warning' : 'badge-danger') + '">' + shift.status + '</span></div></div>' +
        '<div><div class="stat-label">配置人数</div><div style="font-weight:600;font-size:16px;">' + shift.people + '名</div></div>' +
        '<div><div class="stat-label">スコア</div><div style="font-weight:600;font-size:16px;">' + shift.score.toFixed(1) + '</div></div>' +
      '</div>' +
      staffHTML;
  }

  detail.classList.add('active');
}

function changeMonth(delta) {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
  document.getElementById('calendar-detail').classList.remove('active');
  renderCalendar();
}

/* ===== Dashboard Today Summary ===== */
function renderTodaySummary() {
  const today = new Date();
  const minScore = 40; // 通常レベル
  const available = getAvailableStaff(today, '早番');
  const result = algoEfficiency(available, minScore);

  const list = document.getElementById('today-staff-list');
  // Show first 10 with a "+N more" if needed
  const shown = result.staff.slice(0, 10);
  const remaining = result.staff.length - shown.length;
  list.innerHTML = shown.map(s =>
    '<span class="today-staff-chip"><span style="font-weight:600;">' + s.name + '</span> Lv.' + s.skillLevel + '</span>'
  ).join('') + (remaining > 0 ? '<span class="today-staff-chip" style="background:var(--color-primary-container);color:var(--color-primary);">+' + remaining + '名</span>' : '');

  const pct = Math.min((result.totalScore / minScore) * 100, 100);
  document.getElementById('today-score-text').textContent = 'スコア: ' + result.totalScore.toFixed(1) + ' / ' + minScore + ' (' + result.staff.length + '名配置)';

  const statusBadge = document.getElementById('today-status');
  if (result.status === '充足') {
    statusBadge.className = 'badge badge-success';
    statusBadge.textContent = '充足';
  } else {
    statusBadge.className = 'badge badge-danger';
    statusBadge.textContent = '人員不足';
  }

  // Animate score bar
  setTimeout(() => {
    const bar = document.getElementById('today-score-bar');
    bar.style.width = pct + '%';
    bar.style.background = result.status === '充足' ? 'var(--color-success)' : 'var(--color-danger)';
  }, 300);
}

/* ===== Init ===== */
function init() {
  // Set default date to today
  const today = new Date();
  const dateStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
  document.getElementById('shift-date').value = dateStr;

  renderStaffGrid();
  updateShiftInfo();
  renderCalendar();
  renderTodaySummary();

  // Update shift info when date changes
  document.getElementById('shift-date').addEventListener('change', updateShiftInfo);
}

// Close modal on overlay click
document.getElementById('staff-modal').addEventListener('click', function(e) {
  if (e.target === this) closeStaffModal();
});

// Keyboard support
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeStaffModal();
});

init();
</script>
</body>
</html>
